{% extends 'base.html' %}
{% load static %}

{% block body %}
<div class="container py-5">
  <h2>Your Cart ({{ unique_items_count }} items)</h2>
  
  {% if cart_items %}
  <div class="row">
    <!-- Cart Items -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header bg-white">
          <h5>Cart Items</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th scope="col" style="width: 100px;">Image</th>
                  <th scope="col">Product</th>
                  <th scope="col">Price</th>
                  <th scope="col" class="text-center">Quantity</th>
                  <th scope="col" class="text-end">Total</th>
                  <th scope="col" class="text-center">Action</th>
                </tr>
              </thead>
              <tbody>
                {% for item in cart_items %}
                <tr>
                  <td>
                    {% if item.image_url %}
                    <img src="{{ item.image_url }}" alt="{{ item.name }}" class="img-fluid rounded" style="width: 80px; height: 60px; object-fit: cover;">
                    {% else %}
                    <img src="{% static 'images/placeholder.jpg' %}" alt="No image" class="img-fluid rounded" style="width: 80px; height: 60px; object-fit: cover;">
                    {% endif %}
                  </td>
                  <td>{{ item.name }}</td>
                  <td>${{ item.price }}</td>
                  <td class="text-center">
                    <div class="d-flex justify-content-center align-items-center">
                      <button class="btn btn-sm btn-outline-secondary quantity-btn" data-action="decrement" data-id="{{ item.id }}">
                        -
                      </button>
                      <span class="mx-2 quantity-display" id="quantity-{{ item.id }}">
                        {{ item.quantity }}
                      </span>
                      <button class="btn btn-sm btn-outline-secondary quantity-btn" data-action="increment" data-id="{{ item.id }}">
                        +
                      </button>
                    </div>
                  </td>
                  <td class="text-end">$<span id="total-{{ item.id }}">{{ item.total }}</span></td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-danger remove-btn" data-id="{{ item.id }}">
                      <i class="bi bi-trash"></i> Remove
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Cart Summary -->
    <div class="col-md-4">
      <div class="card sticky-top" style="top: 20px;">
        <div class="card-header bg-white">
          <h5>Order Summary</h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span>Items ({{ unique_items_count }}):</span>
            <span>${{ subtotal }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Tax (10%):</span>
            <span>${{ tax }}</span>
          </div>
          <div class="d-flex justify-content-between mb-3">
            <span>Shipping:</span>
            <span>${{ shipping }}</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between mb-3">
            <strong>Total:</strong>
            <strong>${{ total }}</strong>
          </div>
          
          
          <a href="{% url 'payment_page' %}" class="btn btn-primary w-100 mb-2">Proceed to Checkout</a>
          <a href="{% url 'FoodListPage' %}" class="btn btn-outline-secondary w-100">Continue Shopping</a>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <!-- Empty Cart State -->
  <div class="text-center py-5">
    <div class="mb-4">
      <i class="bi bi-cart-x" style="font-size: 4rem; color: #6c757d;"></i>
    </div>
    <h4 class="text-muted">Your cart is empty</h4>
    <p class="text-muted mb-4">Looks like you haven't added any items to your cart yet.</p>
    <div class="d-grid gap-2 d-md-block">
      <a href="{% url 'FoodListPage' %}" class="btn btn-primary me-md-2">Browse Food Menu</a>
      <a href="{% url 'DrinksListPage' %}" class="btn btn-outline-primary">Browse Drinks Menu</a>
    </div>
  </div>
  {% endif %}
</div>

<!-- JavaScript for quantity controls -->
<!-- JavaScript for quantity controls -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Quantity increment/decrement
    document.querySelectorAll('.quantity-btn').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            const itemId = this.dataset.id;
            const quantityDisplay = document.getElementById(`quantity-${itemId}`);
            const totalDisplay = document.getElementById(`total-${itemId}`);
            const price = parseFloat('{{ item.price }}'); // Get price from template
            const currentQuantity = parseInt(quantityDisplay.textContent);
            
            let newQuantity = currentQuantity;
            
            if (action === 'increment') {
                newQuantity = currentQuantity + 1;
            } else if (action === 'decrement' && currentQuantity > 1) {
                newQuantity = currentQuantity - 1;
            }
            
            if (newQuantity !== currentQuantity) {
                // Update via AJAX
                fetch(`/cart/update/${itemId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        quantity: newQuantity
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        quantityDisplay.textContent = newQuantity;
                        totalDisplay.textContent = (data.price * newQuantity).toFixed(2);
                        // Update cart count in navbar
                        const cartCount = document.getElementById('cart-count');
                        if (cartCount) {
                            cartCount.textContent = data.unique_items;
                        }
                        // Reload page to update totals
                        location.reload();
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    });
    
    // Remove item
    document.querySelectorAll('.remove-btn').forEach(button => {
        button.addEventListener('click', function() {
            const itemId = this.dataset.id;
            
            if (confirm('Are you sure you want to remove this item?')) {
                fetch(`/cart/remove/${itemId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update cart count in navbar
                        const cartCount = document.getElementById('cart-count');
                        if (cartCount) {
                            cartCount.textContent = data.unique_items;
                        }
                        // Reload page
                        location.reload();
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    });
    
    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}

{% block footer %}

{% endblock %}
