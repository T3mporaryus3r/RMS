{% extends 'base.html' %}
{% load static %}
{% block title %}Payment{% endblock %}

{% block body %}
<div class="container py-5">
    <h2>Payment</h2>
    <p>Total Amount: <strong>Rs {{ total }}</strong></p>

    <div class="payment-options mt-4">
        <!-- Khalti -->
        <button id="khalti-btn" class="btn btn-outline-primary d-flex align-items-center p-2 mb-2">
            <img src="/static/image/khalti.png" style="height:28px; margin-right:10px" alt="Khalti"> Pay with Khalti
        </button>

            <form action="https://rc-epay.esewa.com.np/api/epay/main/v2/form" method="POST" class="mt-3">
            <input type="hidden" name="amount" value="{{ total }}">
            <input type="hidden" name="tax_amount" value="0">
            <input type="hidden" name="total_amount" value="{{ payload.total_amount }}">
            <input type="hidden" name="transaction_uuid" value="{{ payload.transaction_uuid }}">
            <input type="hidden" name="product_code" value="{{ payload.product_code }}">
            <input type="hidden" name="product_service_charge" value="0">
            <input type="hidden" name="product_delivery_charge" value="0">
            <input type="hidden" name="success_url" value="http://127.0.0.1:8000/payments/esewa-success/">
            <input type="hidden" name="failure_url" value="http://127.0.0.1:8000/payments/esewa-failure/">
            <input type="hidden" name="signed_field_names" value="{{ signed_fields }}">
            <input type="hidden" name="signature" value="{{ signature }}">

            <button type="submit" class="btn btn-outline-success d-flex align-items-center p-2">
                <img src="{% static 'image/esewa-logo.jpg' %}" alt="eSewa"
                    style="height:30px; margin-right:10px;">
                Pay with eSewa
            </button>
        </form>


        <!-- Stripe -->
        <button id="stripe-btn" class="btn btn-dark d-flex align-items-center p-2 mt-2">
            <img src="https://stripe.com/img/v3/home/twitter.png" style="height:28px; margin-right:10px" alt="Stripe"> Pay with Card (Stripe)
        </button>
    </div>
</div>

<!-- Khalti -->
<script src="https://khalti.com/static/khalti-checkout.js"></script>

<script>
// helper to read csrf token from cookie
function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
}

const csrftoken = getCookie('csrftoken');

var khaltiConfig = {
    publicKey: "{{ KHALTI_PUBLIC_KEY }}",
    productIdentity: "cart_{{ request.session.session_key|default:'anon' }}",
    productName: "Food Order",
    productUrl: window.location.origin + "/cart/",
    eventHandler: {
        onSuccess(payload) {
            // payload contains token, amount in paisa etc.
            fetch("{% url 'khalti_verify' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(payload)
            }).then(res => res.json()).then(data => {
                if(data.success) {
                    alert("Khalti: Payment verified!");
                    window.location.href = "/";
                } else {
                    alert("Khalti verification failed.");
                    console.log(data);
                }
            }).catch(err => {
                console.error(err);
                alert("Network error verifying Khalti payment.");
            });
        },
        onError(err) {
            console.error(err);
            alert("Khalti payment error.");
        },
        onClose() {
            console.log("Khalti widget closed");
        }
    },
    amount: Math.round({{ total|floatformat:2 }} * 100)  // paisa
};

var khaltiCheckout = new KhaltiCheckout(khaltiConfig);
document.getElementById("khalti-btn").onclick = function() {
    khaltiCheckout.show({amount: khaltiConfig.amount});
};

// Stripe: create session on server then redirect
document.getElementById("stripe-btn").addEventListener("click", async function() {
    try {
        const resp = await fetch("{% url 'create_checkout_session' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({})  // you can send cart info if desired
        });
        const data = await resp.json();
        if (data.url) {
            window.location.href = data.url;
        } else {
            alert("Stripe session error: " + (data.error || JSON.stringify(data)));
            console.error(data);
        }
    } catch (err) {
        console.error(err);
        alert("Network error creating Stripe session.");
    }
});
</script>
{% endblock %}
{% block footer %}{% endblock %}